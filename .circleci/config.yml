version: 2

jobs:
    build:
        docker:
            - image: cimg/node:14.17.4
        working_directory: ~/protocol
        steps:
            - checkout
            - run:
                name: yarn
                command: yarn
            - save_cache:
                key: protocol-{{ .Environment.CIRCLE_SHA1 }}
                paths:
                    - ~/protocol
    lint:
        docker:
            - image: cimg/node:14.17.4
        working_directory: ~/protocol
        steps:
            - restore_cache:
                keys:
                    - protocol-{{ .Environment.CIRCLE_SHA1 }}
            - run: 
                name: Run linting
                command: yarn lint
    test-contracts:
        docker: 
            - image: cimg/node:14.17.4
        environment:
            SOLC_VERSION: '0.5.11'
        working_directory: ~/protocol
        steps:
            - restore_cache:
                keys:
                    - protocol-{{ .Environment.CIRCLE_SHA1 }}
            - setup_remote_docker:
                version: 17.09.0-ce
            - run:
                name: Install Dockerized solc
                command: docker pull ethereum/solc:$SOLC_VERSION
            - run:
                name: Compile contracts
                command: yarn compile
            - run: 
                name: Run tests with coverage reporting
                command: yarn test:coverage
                no_output_timeout: 20m

workflows:
    version: 2
    main:
        jobs:
            - build
            - lint:
                requires:
                    - build
            - test-contracts:
                requires:
                    - build
            